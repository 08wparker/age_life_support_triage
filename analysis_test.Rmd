---
title: "analysis_test.Rmd"
author: "Michael Hermsen"
date: "2023-05-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Set up

This script will be used to make figures/results for the age/CSC project. It should be run on WashU data. It assumed that the provided dataframe/CSV file is in the same format.

Variables should be:

* encounter
* lfspprt_episode
* sofa_total_48hr
* age_years
* race
* covid
* died
* vent_ever

In this script, the data is assumed to be 1 row per life support episode, with
the 48-hour maximum SOFA score calculated at the beginning of the LSE.

```{r load_libs, message=FALSE}
library(ggplot2)
library(pROC)
library(dplyr)
library(rms)
library(gtsummary)
library(splines)
library(caret)
library(webshot)
library(tidyr)
library(CalibrationCurves)
library(ResourceSelection)
```


```{r load_data, include=FALSE}

# This script will load certain R files which were generated from UC and NW data (though they are all aggregate, nothing identifiable) and use WashU data as a testing set.


# Set your path to load R files here
setwd("C:/Users/t.cri.mhermsen/Documents/UCMC_data_clean/results_combined/UCNW")

# Load files
load("LR_Models.RData")
load("risk_score.RData")

# set path to your WashU data here, if different
setwd("C:/Users/t.cri.mhermsen/Documents/UCMC_data_clean/WashU")

# now load WashU data, save as "data"
data <- read.csv("bjc_deidentified_fixed_2023-02-22.csv")

# for practical coding purposes, i will load our data just to be able to write the script
#data <- read.csv("data_for_analysis.csv")
# select random subset so it's a bit different
#data <- slice_sample(data, n=800, replace=TRUE)
# delete or comment out these lines when running at WashU... ^^

```
## Cleaning
``` {r clean, echo=FALSE}

# getting some errors in the "age group" chunks because some patients have NA values for age
# I will remove these observations

data <- data %>%
  filter(is.na(age_years)==FALSE)
# should remove only 80 obs 18352 --> 18272

# also many with no race...
# probably supposed to be "other", since there are 0 "others"
# will change to "other"
# change to factor
data$race <- factor(data$race)
levels(data$race) <- list("Other" = "",
                          "Hispanic" = "Hispanic",
                          "Non-Hispanic Black" = "Non-Hispanic Black",
                          "Non-Hispanic White" = "Non-Hispanic White")

# we will also fix an error in the "died" variable
# for a small number of patients, (28), they died twice (usually in separate encounters).
# we will set died == 0 for the first encounter.
data <- data %>%
  group_by(patient) %>%
  mutate(died = ifelse(encounter != max(encounter), 0, died))



```

## Table 1

``` {r tab1_sofagroups, echo=FALSE}
# create SOFA groups and LSE length variable for table 1s
data <- data %>%
  group_by(encounter, lfspprt_episode) %>%
  mutate(sofa_group = cut(sofa_total_48hr, breaks=c(-Inf, 7, 11, Inf),
                          labels= c("SOFA 0-7",
                                    "SOFA 8-11",
                                    "SOFA > 11")),
         sofa_cat = sofa_group)
         #lse_greater_7d = ifelse(lfspprt_ep_length >= 168, 1, 0))

```

Patient Level Table 1 (WashU data)

Eval = FALSE since WU data currently doesn't have "patient" variable -- will update.

```{r table1_WU_pt, echo=FALSE}
# as decriptive statistics, table 1 will be run on the WashU data
# we already have table 1 for UC and NW data (together and separate)


tbl1_WU_pt <- data %>%
  ungroup %>%
  arrange(patient, encounter, lfspprt_episode) %>%
  distinct(patient, .keep_all=TRUE) %>% # keeps first instance
  select(age_years,
         sex,
         race,
         sofa_total_48hr,
         sofa_group,
         vent_ever,
         died) %>%
  tbl_summary(
    label = list(age_years = "Age",
                 sofa_total_48hr = "48-hour Maximum SOFA score at beginning of LSE",
                 sofa_group = "SOFA distribution",
                 vent_ever = "Ever on mechanical ventilation",
                 race = "Race/ethnic group",
                 sex = "Sex",
                 died = "Death or discharge to hospice"),
    statistic = age_years ~ "{mean} ({sd})"
  )

tbl1_WU_pt

save(tbl1_WU_pt, file="table1_WU_pt.RData")

gt::gtsave(as_gt(tbl1_WU_pt), filename = "table1_WU_pt.png")

```

Encounter Level Table 1 (WashU data)
```{r table1_WU_enc, echo=FALSE}

tbl1_WU_enc <- data %>%
  ungroup %>%
  #arrange(patient, encounter, lfspprt_episode) %>%
  arrange(encounter, lfspprt_episode) %>%
  distinct(encounter, .keep_all=TRUE) %>% # keeps first instance
  select(age_years,
         sex,
         race,
         sofa_total_48hr,
         sofa_group,
         vent_ever,
         died) %>%
  tbl_summary(
    label = list(age_years = "Age",
                 sofa_total_48hr = "48-hour Maximum SOFA score at beginning of LSE",
                 sofa_group = "SOFA distribution",
                 vent_ever = "Ever on mechanical ventilation",
                 race = "Race/ethnic group",
                 sex = "Sex",
                 died = "Death or discharge to hospice"),
    statistic = age_years ~ "{mean} ({sd})"
  )

tbl1_WU_enc

save(tbl1_WU_enc, file="table1_WU_enc.RData")

gt::gtsave(as_gt(tbl1_WU_enc), filename = "table1_WU_enc.png")

```

LSE Level Table 1 (WashU data)
```{r table1_WU_lse, echo=FALSE}

tbl1_WU_lse <- data %>%
  ungroup %>%
  #arrange(patient, encounter, lfspprt_episode) %>% # nothing to do, already each row is LSE
  arrange(encounter, lfspprt_episode) %>%
  select(age_years,
         sex,
         race,
         sofa_total_48hr,
         sofa_group,
         vent_ever,
         died) %>%
  tbl_summary(
    label = list(age_years = "Age",
                 sofa_total_48hr = "48-hour Maximum SOFA score at beginning of LSE",
                 sofa_group = "SOFA distribution",
                 vent_ever = "Ever on mechanical ventilation",
                 race = "Race/ethnic group",
                 sex = "Sex",
                 died = "Death or discharge to hospice"),
    statistic = age_years ~ "{mean} ({sd})"
  )

tbl1_WU_lse

save(tbl1_WU_lse, file="table1_WU_lse.RData")

gt::gtsave(as_gt(tbl1_WU_lse), filename = "table1_WU_lse.png")

```

``` {r age_groups, echo=FALSE, include=FALSE}

# x axis is deciles of age
# y axis is % mortality in each decile

# however, we will stratify by SOFA score using the following strata
# SOFA <= 7
# SOFA 8-11
# SOFA >= 12
# (same as NY guidelines)

age_groups <- data %>%
  ungroup() %>%
  select(age_years, died, sofa_total_48hr, sofa_group) %>%
  mutate(decile = cut(x=age_years,
                      breaks=c(-Inf, 40, 50, 60, 70, 80, Inf)))

age_group1 <- age_groups %>%
  filter(sofa_total_48hr < 8) %>%
  group_by(decile) %>%
  summarise(mortality = mean(died))
age_group1_counts <- age_groups %>%
  filter(sofa_total_48hr < 8) %>%
  pull(decile) %>%
  table()
age_group1$count <- as.numeric(age_group1_counts)

age_group2 <- age_groups %>%
  filter(sofa_total_48hr >= 8 & sofa_total_48hr <= 11) %>%
  group_by(decile) %>%
  summarise(mortality = mean(died))
age_group2_counts <- age_groups %>%
  filter(sofa_total_48hr >= 8 & sofa_total_48hr <= 11) %>%
  pull(decile) %>%
  table()
age_group2$count <- as.numeric(age_group2_counts)

age_group3 <- age_groups %>%
  filter(sofa_total_48hr > 11) %>%
  group_by(decile) %>%
  summarise(mortality = mean(died)) %>%
  complete(decile, fill=list(mortality=0)) # summarise doesn't include deciles with 0 obs...
age_group3_counts <- age_groups %>%
  filter(sofa_total_48hr > 11) %>%
  pull(decile) %>%
  table()
age_group3$count <- as.numeric(age_group3_counts)

age_group_all <- age_groups %>%
  group_by(sofa_group, decile) %>%
  summarise(mortality = mean(died))
age_group_all$count <- age_groups %>%
  group_by(sofa_group, decile) %>%
  count() %>%
  pull(n)
age_group_all <- age_group_all %>%
  mutate(se = sqrt(mortality * (1-mortality) / (count - 1)))

save(age_group_all, file="age_group_all_WU.RData")

```

Mortality by age group, stratified by SOFA
This combines all SOFA groups into a single plot with 95% CI.
``` {r age_group_all, echo=FALSE}

plt4 <- ggplot(data=age_group_all,
               aes(x=decile, y=mortality, group=sofa_group, color=sofa_group)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=mortality-1.96*se, ymax=mortality+1.96*se), width=0.1) +
  geom_line() +
  theme_bw() +
  theme(
    panel.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = c(0.9, 0.15),
    legend.title = element_blank(),
    legend.background = element_rect(size=0.5, color="black", fill="gray92"),
    legend.key = element_rect(fill="gray92"),
    legend.spacing.y = unit(0, "cm")
  ) +
  xlab("Age Groups (years)") + 
  ylab("Mortality") +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80")) +
  scale_color_manual(values=c("darkgreen", "darkblue", "darkred"))

plt4

ggsave(filename="age_group_all_WU.png")

```

Heatmap of mortality by SOFA and age
``` {r heatmap1, echo=FALSE}
# this can be run on combined data UC + NW
# we will also make separate heatmaps for UC vs NW

# that scaled rainbow plot from MELDNa paper

# make score_rainbow with observed mortality by groups

# 3 categories of sofa
score_rainbow <- data %>%
  ungroup() %>%
  select(died, age_years, sofa_group) %>%
  mutate(age_group = cut(x=age_years,
                         breaks=c(-Inf, 40, 50, 60, 70, 80, Inf))) %>%
  group_by(age_group, sofa_group) %>%
  summarise(mortality=mean(died))

ggplot(data=score_rainbow, mapping=aes(x=age_group, y=sofa_group)) +
  geom_raster(aes(fill=mortality)) +
  scale_fill_gradientn(colors=rev(c("#67001F","#B2182B","#D6604D","#F4A582","#FDDBC7","#D1E5F0","#92C5DE","#4393C3","#2166AC", "#053061")),
                       limits=c(0,1),
                       name="Mortality",
                       na.value="gray20") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = "right",
        #legend.title = element_text("Mortality"),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.5, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  xlab("Age Group (years)") +
  ylab("48-hour Maximum SOFA Score") +
  scale_y_discrete(labels=c("0-7", "8-11", "> 11"),
                   expand=c(0,0)) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80"),
                   expand=c(0,0))

ggsave("heatmap_3x6_WU.png")
save(score_rainbow, file="heatmap_3x6_WU.RData")
```


Heatmap of mortality by SOFA and age (all data)
``` {r heatmap3, echo=FALSE}

# first on all data

# 5 categories (based on quantiles n = 5)
score_rainbow <- data %>%
  ungroup() %>%
  select(died, age_years, sofa_total_48hr) %>%
  mutate(age_group = cut(x=age_years,
                         breaks=c(-Inf, 40, 50, 60, 70, 80, Inf)),
         sofa_group = cut(x=sofa_total_48hr,
                          breaks=c(-Inf, 4, 5, 6, 8, Inf))) %>%
  group_by(age_group, sofa_group) %>%
  summarise(mortality=mean(died))

ggplot(data=score_rainbow, mapping=aes(x=age_group, y=sofa_group)) +
  geom_raster(aes(fill=mortality)) +
  scale_fill_gradientn(colors=rev(c("#67001F","#B2182B","#D6604D","#F4A582","#FDDBC7","#D1E5F0","#92C5DE","#4393C3","#2166AC", "#053061")),
                       limits=c(0,1),
                       name="Mortality",
                       na.value="gray20") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = "right",
        #legend.title = element_text("Mortality"),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.5, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  xlab("Age Group (years)") +
  ylab("48-hour Maximum SOFA Score") +
  scale_y_discrete(labels=c("< 5", "5", "6", "7-8", "> 8"),
                   expand=c(0,0)) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80"),
                   expand=c(0,0))

ggsave("heatmap_5x6_WU.png")
save(score_rainbow, file="heatmap_5x6_WU.RData")
```


## Predict with Logistic Regression Models

Make categories for SOFA score
```{r make_cats, include=FALSE}
# make factor of SOFA categories based off NY guidelines
data <- data %>%
  mutate(sofa_cat = case_when(
    sofa_total_48hr < 8 ~ "SOFA <= 7",
    sofa_total_48hr < 12 ~ "SOFA 8-11",
    sofa_total_48hr >= 12 ~ "SOFA >= 12"
  ))
```


``` {r make_preds, include=FALSE}

# since we are recalibrating to the testing data, we actually need to re-run all the LR models.

# make predictions with recalibrated LR models
lr_sofa_recal <- glm(died ~ sofa_total_48hr,
                     data=data,
                     family="binomial")
lr_sofa_age_recal <- glm(died ~ sofa_total_48hr + age_years,
                        data = data,
                        family="binomial")
lr_sofa_cat_recal <- glm(died ~ sofa_cat,
                         data=data,
                         family="binomial")
data$pred_sofa_recal <- predict(lr_sofa_recal, data)
data$pred_sofaage_recal <- predict(lr_sofa_age_recal, data)
data$pred_sofacat_recal <- predict(lr_sofa_cat_recal, data)
  

data <- data %>%
  mutate(prob_sofa_recal = exp(pred_sofa_recal)/(1+exp(pred_sofa_recal)),
         prob_sofacat_recal = exp(pred_sofacat_recal)/(1+exp(pred_sofacat_recal)),
         prob_sofaage_recal = exp(pred_sofaage_recal)/(1+exp(pred_sofaage_recal)))



#plt5 <- ggplot(data=data, aes(x=age_years, y=logodds_sofasplage)) +
#  geom_point() +
#  geom_abline(slope=-0.01639, intercept=-2.48500+1.06805) +
#  geom_abline(slope=0.04904, intercept=-4.03415)
  

#plt5

#ggsave(filename="spline.png")

```


## Make ROC objects

``` {r make_roc_LRs, message=FALSE}

roc_sofa_recal <- roc(data$died,
                      data$prob_sofa_recal,
                      auc=TRUE,
                      ci=TRUE)

roc_sofa_age_recal <- roc(data$died,
                          data$prob_sofaage_recal,
                          auc=TRUE,
                          ci=TRUE)

roc_sofa_cat_recal <- roc(data$died,
                          data$prob_sofacat_recal,
                          auc=TRUE,
                          ci=TRUE)

roc.list <- list(roc_sofa_recal,
                 roc_sofa_cat_recal,
                 roc_sofa_age_recal)

save(roc.list, file="ROCs.RData")
```

``` {r test_rocs, message=TRUE, echo=FALSE}
# use recalibrated but it shouldn't matter.
# sofa only vs sofa cat
roc.test(roc_sofa_recal, roc_sofa_cat_recal,
         method="delong",
         paired=TRUE,
         alternative = "two.sided",
         conf.level=0.95)

# sofa only vs sofa age
roc.test(roc_sofa_recal, roc_sofa_age_recal,
         method="delong",
         paired=TRUE,
         alternative = "two.sided",
         conf.level=0.95)

# sofa cat vs sofa age
roc.test(roc_sofa_cat_recal, roc_sofa_age_recal,
         method="delong",
         paired=TRUE,
         alternative = "two.sided",
         conf.level=0.95)

```

## Make plots

First, we'll make a plot with all the ROC curves on one.
``` {r plot_LR, echo=FALSE, eval=FALSE}
# use recalibrated models
fig1 <- ggroc(roc.list,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.75,0.3),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92"),
        aspect.ratio = 1
  ) + 
  scale_color_brewer(palette="Set1") +
  scale_color_manual(values=c("darkgreen", "darkblue", "darkred", "lightsalmon")) +
  geom_abline(slope = 1, intercept = 1, color = "gray")

levels(fig1$data$name) <- c(paste("48-hour max SOFA,\nAUC = ",
                                  round(roc_sofa$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA\nby NY categories,\nAUC = ",
                                  round(roc_sofa_cat$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA\nand Age,\nAUC = ",
                                  round(roc_sofa_age$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA and\nlinear spline of Age,\nAUC = ",
                                  round(roc_sofa_splage$auc, 3),
                                  "\n"))

plot(fig1)

ggsave(filename="ROC_all.png")
```

``` {r plot_LR_3, echo=FALSE}

# we will make the same plot without splage.
# use recalibrated models

# make 95% ci
ci.list <- lapply(roc.list, ci.se)
dat.ci.list <- lapply(ci.list, function(ciobj)
  data.frame(x = as.numeric(rownames(ciobj)),
             lower = ciobj[, 1],
             upper = ciobj[, 3]))

dat.ci.list

# method from:
# https://stackoverflow.com/questions/64692484/how-to-draw-multiple-roc-curves-with-confidence-interval-in-proc

fig1a <- ggroc(roc.list,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.75,0.28),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(1, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92"),
        aspect.ratio = 1
  ) + 
  scale_color_brewer(palette="Set1") +
  scale_color_manual(values=c("darkgreen", "darkblue", "darkred")) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  geom_ribbon(data = dat.ci.list[[1]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkgreen",
              inherit.aes=FALSE) +
  geom_ribbon(data = dat.ci.list[[2]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkblue",
              inherit.aes=FALSE) +
  geom_ribbon(data = dat.ci.list[[3]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkred",
              inherit.aes=FALSE)

levels(fig1a$data$name) <- c(paste("48-hour max SOFA,\nAUC = ",
                                  round(roc_sofa_recal$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA\nby NY categories,\nAUC = ",
                                  round(roc_sofa_cat_recal$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA\nand Age,\nAUC = ",
                                  round(roc_sofa_age_recal$auc, 3),
                                  "\n"))


plot(fig1a)

ggsave(filename="ROC_all.png")
```

``` {r plot_sofa, echo=FALSE}
fig2 <- ggroc(roc_sofa_recal,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        aspect.ratio = 1
  ) + 
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  #geom_rect(aes(xmin=0, xmax=0.5, ymin=0.0625, ymax=0.1875),
  #          color="black",
  #          fill="gray92") +
  geom_text(aes(x=0.25, y=0.125),
            label=paste("AUC = ", round(roc_sofa_recal$auc, 3)),
            size=5)


plot(fig2)

ggsave(filename="ROC_sofa.png")
```

``` {r plot_sofa_cat, echo=FALSE}
fig3 <- ggroc(roc_sofa_cat_recal,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        aspect.ratio = 1) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  #geom_rect(aes(xmin=0, xmax=0.5, ymin=0.0625, ymax=0.1875),
  #          color="black",
  #          fill="gray92")+
  geom_text(aes(x=0.25, y=0.125),
            label=paste("AUC = ", round(roc_sofa_cat_recal$auc, 3)),
            size=5)

plot(fig3)

ggsave(filename="ROC_sofa_cat.png")
```

``` {r plot_sofa_age, echo=FALSE}
fig4 <- ggroc(roc_sofa_age_recal,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        aspect.ratio = 1) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  #geom_rect(aes(xmin=0, xmax=0.5, ymin=0.0625, ymax=0.1875),
  #          color="black",
  #          fill="gray92")+
  geom_text(aes(x=0.25, y=0.125),
            label=paste("AUC = ", round(roc_sofa_age_recal$auc, 3)),
            size=5)

plot(fig4)

ggsave(filename="ROC_sofa_age.png")
```

``` {r plot_sofa_splage, echo=FALSE, eval=FALSE}
fig5 <- ggroc(roc_sofa_splage,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        aspect.ratio = 1) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  #geom_rect(aes(xmin=0, xmax=0.5, ymin=0.0625, ymax=0.1875),
  #          color="black",
  #          fill="gray92")+
  geom_text(aes(x=0.25, y=0.125),
            label=paste("AUC = ", round(roc_sofa_splage$auc, 3)),
            size=5)

plot(fig5)

ggsave(filename="ROC_sofa_splage.png")
```

## Calibration Curves

Calibration for SOFA model
``` {r cal_sofa, echo=FALSE, warning=FALSE}
png(file="cal_sofa_ci.png")
val.prob.ci.2(p=data$prob_sofa_recal, y=data$died)
dev.off()

val.prob.ci.2(p=data$prob_sofa_recal, y=data$died)
```

Calibration for SOFA category model
``` {r cal_sofa_cat, echo=FALSE, warning=FALSE}
png(file="cal_sofa_cat_ci.png")
val.prob.ci.2(p=data$prob_sofacat_recal,  y=data$died, smooth="none", logistic.cal=TRUE)
# returns error if trying to do normal "Loess smooth" method
# had to set smooth = "none" and get a logistic calibration.
dev.off()

val.prob.ci.2(p=data$prob_sofacat_recal,  y=data$died, smooth="none", logistic.cal=TRUE)
```

Calibration for SOFA + age model
``` {r cal_sofa_age, echo=FALSE, warning=FALSE}
png(file="cal_sofa_age_ci.png")
val.prob.ci.2(p=data$prob_sofaage_recal, y=data$died)
dev.off()

val.prob.ci.2(p=data$prob_sofaage_recal, y=data$died)
```

Calibration for SOFA + linear spline of age model
``` {r cal_sofa_splage, echo=FALSE, warning=FALSE, eval=FALSE}
png(file="cal_sofa_splage_ci.png")
val.prob.ci.2(p=data$prob_sofasplage_recal, y=data$died)

val.prob.ci.2(p=data$prob_sofasplage_recal, y=data$died)
dev.off()
```


``` {r risk_score}

# we have already loaded the LR model "lr_score", as well as the "m" value used to make it.
# we really only need the "m" value.



data <- data %>%
  mutate(score = m*(age_years - 18) + sofa_total_48hr,
         score = ifelse(age_years > 98, m*80 + sofa_total_48hr, score))

roc_score <- roc(response=data$died,
                  predictor=data$score,
                  auc=TRUE)

# rename the lr_score model loaded from UC and NW data
lr_score_train <- lr_score

# save new lr_score
lr_score <- glm(died ~ score,
                data=data,
                family="binomial")

# pred_score from old LR (not recalibrated)
data$pred_score <- predict(lr_score_train, data)
data <- data %>%
  mutate(prob_score = exp(pred_score)/(1+exp(pred_score)))

roc_score$auc

# pred_score_recal from new LR (recalibrated)
data$pred_score_recal <- predict(lr_score, data)
data <- data %>%
  mutate(prob_score_recal = exp(pred_score_recal)/(1+exp(pred_score_recal)))

roc_score_recal <- roc(response=data$died,
                       predictor=data$prob_score,
                       auc=TRUE,
                       ci=TRUE)
roc_score_recal$auc

# they are the same, which makes sense. Recalibration would not affect the rank ordering.
```

``` {r risk_score_roc}
# make ci
ciobj <- ci.se(roc_score_recal)
dat.ci <- data.frame(x = as.numeric(rownames(ciobj)),
                     lower = ciobj[, 1],
                     upper = ciobj[, 3])

fig6 <- ggroc(roc_score_recal,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        aspect.ratio = 1) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  #geom_rect(aes(xmin=0, xmax=0.5, ymin=0.0625, ymax=0.1875),
  #          color="black",
  #          fill="gray92")+
  geom_text(aes(x=0.25, y=0.125),
            label=paste("AUC = ", round(roc_score$auc, 3)),
            size=5) +
  geom_ribbon(data=dat.ci, aes(x=x, ymin=lower, ymax=upper), alpha=0.3)

plot(fig6)

ggsave(filename="ROC_sofa_score.png")

``` 

``` {r plot_LR_3_APSI, echo=FALSE}

# sofa, sofa cat, APSI
# use recalibrated models

roc.list2 <- list(roc_sofa_recal,
                 roc_sofa_cat_recal,
                 roc_score_recal)

# make 95% ci
ci.list <- lapply(roc.list2, ci.se)
dat.ci.list <- lapply(ci.list, function(ciobj)
  data.frame(x = as.numeric(rownames(ciobj)),
             lower = ciobj[, 1],
             upper = ciobj[, 3]))

dat.ci.list

# method from:
# https://stackoverflow.com/questions/64692484/how-to-draw-multiple-roc-curves-with-confidence-interval-in-proc

fig1a <- ggroc(roc.list2,
      size = 1.065) +
  theme_bw() +
  labs(x = "Specificity",
       y = "Sensitivity") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.75,0.28),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(1, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92"),
        aspect.ratio = 1
  ) + 
  scale_color_brewer(palette="Set1") +
  scale_color_manual(values=c("darkgreen", "darkblue", "darkred")) +
  geom_abline(slope = 1, intercept = 1, color = "gray") +
  geom_ribbon(data = dat.ci.list[[1]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkgreen",
              inherit.aes=FALSE) +
  geom_ribbon(data = dat.ci.list[[2]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkblue",
              inherit.aes=FALSE) +
  geom_ribbon(data = dat.ci.list[[3]],
              aes(x=x, ymin=lower, ymax=upper),
              alpha=0.3,
              fill = "darkred",
              inherit.aes=FALSE)

levels(fig1a$data$name) <- c(paste("48-hour max SOFA,\nAUC = ",
                                  round(roc_sofa_recal$auc, 3),
                                  "\n"),
                            paste("48-hour max SOFA\nby NY categories,\nAUC = ",
                                  round(roc_sofa_cat_recal$auc, 3),
                                  "\n"),
                            paste("APSI Score,\nAUC = ",
                                  round(roc_score_recal$auc, 3),
                                  "\n"))


plot(fig1a)

ggsave(filename="ROC_all_APSI.png")
```

``` {r print_lr_results}
lr_sofa_recal$coefficients
exp(lr_sofa_recal$coefficients)
confint(lr_sofa_recal)
summary(lr_sofa_recal)

lr_sofa_cat_recal$coefficients
exp(lr_sofa_cat_recal$coefficients)
confint(lr_sofa_cat_recal)
summary(lr_sofa_cat_recal)

lr_score_recal$coefficients
exp(lr_score_recal$coefficients)
confint(lr_score_recal)
summary(lr_score_recal)
```

``` {r risk_score_hist}

ggplot(data=data) +
  geom_histogram(data=data, aes(score), color="black", fill="gray") +
  theme_bw() +
  labs(x = "Risk Score",
       y = "Count") + 
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16)) +
  scale_x_continuous(limits=c(0,40))

ggsave(filename="risk_score_hist_WU.png")

```

``` {r cal_byscore_plot, echo=FALSE, eval=FALSE}

# new dataframe of deciles of score
# deciles of SOFA
# observed % probability survival for each score
# LR outcome (pred prob survival)
# LR outcome for SOFA

# not recalibrated

score_data <- data %>%
  ungroup() %>%
  select(sofa_total_48hr, score, prob_sofa, prob_sofaage, prob_score, died) %>%
  mutate(sofa_deciles = ntile(sofa_total_48hr, 10),
         score_deciles = ntile(score, 10))

score_data_tiled <- score_data %>%
  group_by(sofa_deciles) %>%
  summarise(obs_sofa_mortality = mean(died)) %>%
  rename(deciles = sofa_deciles)

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(obs_score_mortality = mean(died)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(pred_score_mortality = mean(prob_score)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(pred_sofa_mortality = mean(prob_sofa)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(sofa_deciles) %>%
  summarise(pred_sofa_mortality_by_sofa_deciles = mean(prob_sofa)) %>%
  rename(deciles = sofa_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, obs_score_mortality) %>%
  mutate(group = "Observed Mortality") %>%
  rename(mortality = obs_score_mortality)

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, pred_score_mortality) %>%
  mutate(group = "Predicted Mortality by Risk Score") %>%
  rename(mortality = pred_score_mortality) %>%
  rbind(score_data_tiled_gg)

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, pred_sofa_mortality) %>%
  mutate(group = "Predicted Mortality by SOFA Score") %>%
  rename(mortality = pred_sofa_mortality) %>%
  rbind(score_data_tiled_gg)

ggplot(data=score_data_tiled_gg, aes(x=deciles,
                                     y=mortality,
                                     fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Deciles of Risk Score (Not Recalibrated)") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.25,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                   labels=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  scale_y_continuous(breaks=seq(0.1, 0.9, 0.1),
                     labels=c("10", "20", "30", "40", "50", "60", "70", "80", "90"))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_byscore.png")
save(score_data_tiled, file="score_data_tiled.RData")
  
```

``` {r cal_byscore_recal_plot, echo=FALSE}

# new dataframe of deciles of score
# deciles of SOFA
# observed % probability survival for each score
# LR outcome (pred prob survival)
# LR outcome for SOFA

# recalibrated

score_data <- data %>%
  ungroup() %>%
  select(sofa_total_48hr, score, prob_sofa_recal, prob_sofaage_recal, prob_score_recal, died) %>%
  mutate(sofa_deciles = ntile(sofa_total_48hr, 10),
         score_deciles = ntile(score, 10))

score_data_tiled <- score_data %>%
  group_by(sofa_deciles) %>%
  summarise(obs_sofa_mortality = mean(died)) %>%
  rename(deciles = sofa_deciles)

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(obs_score_mortality = mean(died)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(pred_score_mortality = mean(prob_score_recal)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(score_deciles) %>%
  summarise(pred_sofa_mortality = mean(prob_sofa_recal)) %>%
  rename(deciles = score_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled <- score_data %>%
  group_by(sofa_deciles) %>%
  summarise(pred_sofa_mortality_by_sofa_deciles = mean(prob_sofa_recal)) %>%
  rename(deciles = sofa_deciles) %>%
  full_join(score_data_tiled, by="deciles")

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, obs_score_mortality) %>%
  mutate(group = "Observed Mortality") %>%
  rename(mortality = obs_score_mortality)

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, pred_score_mortality) %>%
  mutate(group = "Predicted Mortality by APSI Score") %>%
  rename(mortality = pred_score_mortality) %>%
  rbind(score_data_tiled_gg)

score_data_tiled_gg <- score_data_tiled %>%
  select(deciles, pred_sofa_mortality) %>%
  mutate(group = "Predicted Mortality by SOFA Score") %>%
  rename(mortality = pred_sofa_mortality) %>%
  rbind(score_data_tiled_gg)

ggplot(data=score_data_tiled_gg, aes(x=deciles,
                                     y=mortality,
                                     fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Deciles of APSI or SOFA Score") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.25,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_continuous(breaks=c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),
                   labels=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
  scale_y_continuous(breaks=seq(0.1, 0.9, 0.1),
                     labels=c("10", "20", "30", "40", "50", "60", "70", "80", "90"))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_byscore_WU.png",
       width=7,
       height=5,
       units=c("in"))
save(score_data_tiled, file="score_data_tiled.RData")
  
```

``` {r cal_byage_plot, echo=FALSE, eval=FALSE}
# same but with age on x axis

# age groups
# observed mortality by age group
# pred mortality by score age group
# pred mortality by sofa age group

# not recalibrated 

age_groups <- data %>%
  ungroup() %>%
  select(age_years, died, prob_sofa, prob_score) %>%
  mutate(age_group = cut(x=age_years,
                      breaks=c(-Inf, 40, 50, 60, 70, 80, Inf))) %>%
  select(-age_years)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(died)) %>%
  mutate(group = "Observed Mortality")

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_score)) %>%
  mutate(group = "Predicted Mortality by Risk Score (Not Recalibrated)") %>%
  rbind(age_groups_sum)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_sofa)) %>%
  mutate(group = "Predicted Mortality by SOFA Score") %>%
  rbind(age_groups_sum)

ggplot(data=age_groups_sum, aes(x=age_group,
                                y=mortality,
                                fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Age Group (years)") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.25,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80")) +
  scale_y_continuous(breaks=seq(0.1, 0.9, 0.1),
                     labels=c("10", "20", "30", "40", "50", "60", "70", "80", "90"),
                     limits=c(0, 0.7))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_byage.png")
save(age_groups, file="age_groups_predictions.RData")

```

``` {r cal_byage_recal_plot, echo=FALSE}
# same but with age on x axis

# age groups
# observed mortality by age group
# pred mortality by score age group
# pred mortality by sofa age group

# recalibrated 

age_groups <- data %>%
  ungroup() %>%
  select(age_years, died, prob_sofa_recal, prob_score_recal, sofa_total_48hr) %>%
  mutate(age_group = cut(x=age_years,
                      breaks=c(-Inf, 40, 50, 60, 70, 80, Inf))) %>%
  select(-age_years)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(died)) %>%
  mutate(group = "Observed Mortality")

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_score_recal)) %>%
  mutate(group = "Predicted Mortality by Risk Score") %>%
  rbind(age_groups_sum)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_sofa_recal)) %>%
  mutate(group = "Predicted Mortality by SOFA Score") %>%
  rbind(age_groups_sum)

ggplot(data=age_groups_sum, aes(x=age_group,
                                y=mortality,
                                fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Age Group (years)") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.25,0.85),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80")) +
  scale_y_continuous(breaks=seq(0.05, 0.45, 0.05),
                     labels=c("5", "10", "15", "20", "25", "30", "35", "40", "45"),
                     limits=c(0, 0.35))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_byage.png")
save(age_groups, file="age_groups_predictions.RData")

```

``` {r cal_byage_plot_NOTRISKSCORE, echo=FALSE}
# same but with age on x axis

# age groups
# observed mortality by age group
# pred mortality by score age group
# pred mortality by sofa age group

age_groups <- data %>%
  ungroup() %>%
  select(age_years, died, prob_sofa_recal, prob_sofaage_recal) %>%
  mutate(age_group = cut(x=age_years,
                      breaks=c(-Inf, 40, 50, 60, 70, 80, Inf))) %>%
  select(-age_years)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(died)) %>%
  mutate(group = "Observed Mortality")

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_sofaage_recal)) %>%
  mutate(group = "Predicted Mortality by SOFA and Age") %>%
  rbind(age_groups_sum)

age_groups_sum <- age_groups %>%
  group_by(age_group) %>%
  summarise(mortality = mean(prob_sofa_recal)) %>%
  mutate(group = "Predicted Mortality by SOFA Score") %>%
  rbind(age_groups_sum)

ggplot(data=age_groups_sum, aes(x=age_group,
                                y=mortality,
                                fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Age Group (years)") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.25,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80")) +
  scale_y_continuous(breaks=seq(0.1, 0.9, 0.1),
                     labels=c("10", "20", "30", "40", "50", "60", "70", "80", "90"),
                     limits=c(0, 0.7))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_NOTRISKSCORE_byage.png")
save(age_groups, file="age_groups_NOTRISKSCORE_predictions.RData")

```

``` {r hoslem}
# perform hosmer-lemeshow test on calibration data by age groups

# we will also do this manually since ResourceSelection::hoslem.test() would calculate by deciles of risk score by default instead of by age groups (which we want)

# first, the default built-in H-L on risk score
# g=10 --> deciles
hoslem.test(x=data$died, y=lr_score$fitted.values, g=10)
# this would be paired with first calibration figure (by deciles)

# next, the defulat built-in H-L on SOFA lone
hoslem.test(x=data$died, y=data$prob_sofa_recal, g=10)
# this would also be paired with first calibration figure

# now manual calculation by age groups
# formula:
# sum_(i=1 to i=6) ( (Observed.Dead - Expected.Dead)^2/Expected.Dead + (Observed.Alive - Expected.Alive)^2/Expected.Alive )

# Age group 1 (i=1)
Observed.Dead <- filter(data, age_years < 40) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years < 40) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years < 40)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years < 40) %>% pull(prob_score)))
AgeGroup.1 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 2 (i=2)
Observed.Dead <- filter(data, age_years >= 40 & age_years < 50) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 40 & age_years < 50) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 40 & age_years < 50)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 40 & age_years < 50) %>% pull(prob_score)))
AgeGroup.2 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 3 (i=3)
Observed.Dead <- filter(data, age_years >= 50 & age_years < 60) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 50 & age_years < 60) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 50 & age_years < 60)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 50 & age_years < 60) %>% pull(prob_score)))
AgeGroup.3 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 4 (i=4)
Observed.Dead <- filter(data, age_years >= 60 & age_years < 70) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 60 & age_years < 70) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 60 & age_years < 70)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 60 & age_years < 70) %>% pull(prob_score)))
AgeGroup.4 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 5 (i=5)
Observed.Dead <- filter(data, age_years >= 70 & age_years < 80) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 70 & age_years < 80) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 70 & age_years < 80)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 70 & age_years < 80) %>% pull(prob_score)))
AgeGroup.5 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 6 (i=6)
Observed.Dead <- filter(data, age_years >= 80) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 80) %>% pull(prob_score) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 80)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 80) %>% pull(prob_score)))
AgeGroup.6 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Hosmer-Lemeshow test statistic is sum of these
HL_statistic.score <- AgeGroup.1 + AgeGroup.2 + AgeGroup.3 + AgeGroup.4 + AgeGroup.5 + AgeGroup.6
HL_statistic.score

# to get p-value, we compare HL_statistic to Chi^2 distribution with Q-2 df (Q = # of groups, here Q = 6)
pchisq(q=HL_statistic.score, df=4, lower.tail=FALSE)

# repeat with SOFA alone by age groups

# Age group 1 (i=1)
Observed.Dead <- filter(data, age_years < 40) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years < 40) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years < 40)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years < 40) %>% pull(prob_sofa_recal)))
AgeGroup.1 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 2 (i=2)
Observed.Dead <- filter(data, age_years >= 40 & age_years < 50) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 40 & age_years < 50) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 40 & age_years < 50)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 40 & age_years < 50) %>% pull(prob_sofa_recal)))
AgeGroup.2 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 3 (i=3)
Observed.Dead <- filter(data, age_years >= 50 & age_years < 60) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 50 & age_years < 60) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 50 & age_years < 60)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 50 & age_years < 60) %>% pull(prob_sofa_recal)))
AgeGroup.3 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 4 (i=4)
Observed.Dead <- filter(data, age_years >= 60 & age_years < 70) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 60 & age_years < 70) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 60 & age_years < 70)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 60 & age_years < 70) %>% pull(prob_sofa_recal)))
AgeGroup.4 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 5 (i=5)
Observed.Dead <- filter(data, age_years >= 70 & age_years < 80) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 70 & age_years < 80) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 70 & age_years < 80)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 70 & age_years < 80) %>% pull(prob_sofa_recal)))
AgeGroup.5 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Age group 6 (i=6)
Observed.Dead <- filter(data, age_years >= 80) %>% pull(died) %>% sum()
Expected.Dead <- filter(data, age_years >= 80) %>% pull(prob_sofa_recal) %>% sum()
Observed.Alive <- nrow(filter(data, age_years >= 80)) - Observed.Dead
Expected.Alive <- sum(1 - (filter(data, age_years >= 80) %>% pull(prob_sofa_recal)))
AgeGroup.6 <- ((Observed.Dead - Expected.Dead)**2)/Expected.Dead + ((Observed.Alive - Expected.Alive)**2)/Expected.Alive

# Hosmer-Lemeshow test statistic is sum of these
HL_statistic.sofa <- AgeGroup.1 + AgeGroup.2 + AgeGroup.3 + AgeGroup.4 + AgeGroup.5 + AgeGroup.6
HL_statistic.sofa

pchisq(q=HL_statistic.sofa, df=4, lower.tail=FALSE)
```

``` {r avg_calibration_error_age, echo=FALSE}
#avg % calibration error by age groups
avg_calerror <- age_groups_sum %>%
  filter(group == "Observed Mortality") %>%
  rename(mortality_obs = mortality) %>%
  select(-group)

avg_calerror <- age_groups_sum %>%
  filter(group == "Predicted Mortality by SOFA Score") %>%
  rename(mortality_SOFA = mortality) %>%
  full_join(avg_calerror)
  
avg_calerror <- age_groups_sum %>%
  filter(group == "Predicted Mortality by Risk Score") %>%
  rename(mortality_risk = mortality) %>%
  bind_rows(avg_calerror)

avg_calerror$mortality_obs[1:6] = avg_calerror$mortality_obs[7:12]

avg_calerror <- avg_calerror %>%
         mutate(diff = ifelse(is.na(mortality_risk), mortality_SOFA - mortality_obs, mortality_risk - mortality_obs),
                diff_percent = diff / mortality_obs) %>%
  select(age_group, group, diff, diff_percent) %>%
  mutate(group = ifelse(group == "Predicted Mortality by SOFA Score", "SOFA Score", "Risk Score"))



# start here
ggplot(data=avg_calerror, aes(x=age_group,
                                y=diff_percent,
                                fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("dodgerblue", "indianred")) +
  xlab("Age Group (years)") +
  ylab("Average Error in Mortality Prediction") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.8,0.8),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_discrete(labels=c("< 40",
                            "40-50",
                            "50-60",
                            "60-70",
                            "70-80",
                            "> 80")) +
  scale_y_continuous(breaks=seq(-0.5, 1.25, 0.25),
                     labels=c("-50%", "-25%", "0%", "+25%", "+50%", "+75%", "+100%", "+125%"),
                     limits=c(-0.5, 1.15))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_error_percent_byage.png")
```

``` {r mortality_by_race}

mort_race <- data %>%
  group_by(race) %>%
  summarise(mortality = mean(prob_sofa_recal)) %>%
  as.data.frame() %>%
  mutate(group = "Predicted Mortality by SOFA Score")

mort_race <- data %>%
  group_by(race) %>%
  summarise(mortality = mean(prob_score_recal)) %>%
  as.data.frame() %>%
  mutate(group = "Predicted Mortality by Risk Score") %>%
  rbind(mort_race)

mort_race <- data %>%
  group_by(race) %>%
  summarise(mortality = mean(died)) %>%
  as.data.frame() %>%
  mutate(group = "Observed Mortality") %>%
  rbind(mort_race)

ggplot(data=mort_race, aes(x=factor(race, levels=c("Non-Hispanic White", "Non-Hispanic Black", "Hispanic", "Other")),
                           y=mortality,
                           fill=group)) +
  geom_col(position="dodge",
           color="black") +
  scale_fill_manual(values=c("gray30", "dodgerblue", "indianred")) +
  xlab("Race/Ethnicity") +
  ylab("Life-support Episode Mortality (%)") +
  theme_bw() +
  theme(panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 14, color="black"),
        axis.title = element_text(size = 16),
        legend.position = c(0.8,0.875),
        legend.title = element_blank(),
        legend.text = element_text(size = 8, color="black"),
        legend.direction = "vertical",
        legend.key.width = unit(0.5, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        legend.spacing.y = unit(0, 'cm'),
        legend.key = element_rect(fill="gray92"),
        legend.background = element_rect(size=0.5, color="black", fill="gray92")
  ) +
  scale_x_discrete(labels=c("Non-Hispanic\nWhite",
                            "Non-Hispanic\nBlack",
                            "Hispanic",
                            "Other")) +
  scale_y_continuous(breaks=seq(0, 0.2, 0.05),
                     labels=c("0", "5", "10", "15", "20"),
                     limits=c(0, 0.2))# +
  #geom_text(data=score_data_tiled_gg, aes(label=mortality))

ggsave(filename="Calibration_bar_byrace.png")
save(age_groups, file="race_predictions.RData")

save(mort_race, file="Mortality_by_race_WU.RData")
```